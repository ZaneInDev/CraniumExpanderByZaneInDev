local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

RunService.RenderStepped:Connect(function()
    local LocalPlayerTeam = Players.LocalPlayer.Team
    for _, Player in pairs(Players:GetPlayers()) do
        if Player.Name ~= Players.LocalPlayer.Name then
            if not getgenv().TeamCheck or Player.Team ~= LocalPlayerTeam then
                local Character = Player.Character or Player.CharacterAdded:Wait()
                local Head = Character:FindFirstChild("Head")
                local Humanoid = Character:WaitForChild("Humanoid")
                local Invisible = getgenv().Invisible

                if Head and Humanoid and Humanoid.RigType == Enum.HumanoidRigType.R15 then
                    local Torso = Character:FindFirstChild("UpperTorso")
                    local ClonedHead = Torso:FindFirstChild("ClonedHead")
                    if not ClonedHead then
                        local NewHead = Head:Clone()
                        NewHead.Name = "ClonedHead"
                        NewHead.Parent = Torso
                    end
                end

                for _, Face in ipairs(Character:GetDescendants()) do
                    if Face:IsA("Decal") and Face.Name == "face" then
                        Face:Destroy()
                    end
                end

                if Invisible then
                    Transparency = 1
                else
                    Transparency = 0
                end

                if Head then
                    Head.Massless = true
                    Head.Size = Vector3.new(getgenv().HeadSize, getgenv().HeadSize, getgenv().HeadSize)
                    Head.Color = Player.TeamColor.Color
                    Head.Material = "ForceField"
                    Head.Transparency = Transparency
                    Head.CanCollide = false
                end

                if getgenv().DeathAnim then
                    Character.Humanoid.Died:Connect(function()
                        local RespawnTime = Players.RespawnTime
                        local Tween = game:GetService('TweenService'):Create(Head, TweenInfo.new(RespawnTime, Enum.EasingStyle.Quint, Enum.EasingDirection.Out), {Size = Vector3.new(0, 0, 0)})
                        Tween:Play()
                        if Head then
                            Head.Size = Vector3.new(0, 0, 0)
                        end
                    end)
                end
            end
        end
    end
end)
